# Dropout 检测原理详解

## 概述

当前的陡增陡降检测**不是基于 dB 值的差异**，而是基于 **RMS（均方根）能量值**的对比。

## 核心原理

### 1. RMS 计算

```python
RMS = sqrt(mean(samples²))
```

- **定义**：Root Mean Square（均方根），音频信号的能量度量
- **范围**：0.0 ~ 1.0（归一化后）或 0 ~ 32767（16位音频）
- **物理意义**：反映音频的"响度"或"能量级别"

**不涉及 dB 转换**！直接使用线性 RMS 值进行判断。

---

## 检测机制

### ❌ 不是：简单的前后帧对比

```
错误理解：
Frame N-1: RMS = 0.3
Frame N:   RMS = 0.1  ← 如果 RMS 差 > 阈值，就报告陡降
```

### ✅ 实际方法

#### **方法 1：陡降到静音（绝对值判断）**

```python
# 检测条件
if rms < 0.01 AND zcr < 0.05:
    报告 "陡降到静音"
```

- **RMS 阈值**：`0.01`（绝对值，非常安静）
- **ZCR 阈值**：`0.05`（零交叉率，判断是真静音还是低频噪声）
- **触发条件**：**同时满足**两个条件

**特点**：
- ✓ 不依赖历史帧
- ✓ 绝对值判断，不是相对变化
- ✓ 即使前一帧也很安静，仍然会触发

**示例**：
```
Frame 100: RMS = 0.30 (正常语音)
Frame 101: RMS = 0.28 (正常)
Frame 102: RMS = 0.005, ZCR = 0.02  ← 触发陡降！
```

---

#### **方法 2：陡增尖刺（历史平均对比）**

```python
# 检测条件
recent_rms_list = [最近5帧的RMS]
avg_rms = mean(recent_rms_list)

if avg_rms > 0.05 AND current_rms > avg_rms * 3.0:
    报告 "陡增尖刺"
```

- **历史窗口**：最近 5 帧（约 50ms）
- **倍数阈值**：当前 RMS 是平均值的 **3 倍**
- **最小平均值**：`avg_rms > 0.05`（避免从极安静突然到正常也误报）

**特点**：
- ✓ 对比历史平均值（非单帧）
- ✓ 相对变化判断，适应不同音量级别
- ✓ 需要至少 5 帧历史数据

**示例**：
```
Frame 95-99: RMS = [0.15, 0.18, 0.16, 0.17, 0.15]  → avg = 0.162
Frame 100:   RMS = 0.90  ← 0.90 > 0.162 * 3 (0.486) → 触发陡增！
```

---

## 为什么不用 dB？

### 当前方案（RMS 线性值）

**优点**：
- ✅ 计算简单，速度快
- ✅ 直观易理解（0.3 是 0.1 的 3 倍）
- ✅ 适合实时处理

**缺点**：
- ❌ 不符合人耳感知（人耳对响度是对数感知）
- ❌ 对微小声音变化不敏感

### 如果改用 dB（对数值）

**公式**：
```python
dB = 20 * log10(RMS / reference)
```

**优点**：
- ✅ 符合人耳感知
- ✅ 对小音量变化更敏感
- ✅ 行业标准表示法

**缺点**：
- ❌ 计算开销略大（log10）
- ❌ 需要定义参考值（reference）
- ❌ RMS = 0 时会产生 -∞ dB

**对比示例**：
```
线性 RMS：
  0.01 → 0.03 = 3倍增长
  0.10 → 0.30 = 3倍增长  （看起来相同）

dB 值：
  0.01 → 0.03 = -40dB → -30dB = +10dB
  0.10 → 0.30 = -20dB → -10dB = +10dB  （确实相同）
```

---

## 参数详解

### 陡降参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `silence_rms_threshold` | 0.01 | 静音判断阈值（绝对值） |
| `dropout_zcr_threshold` | 0.05 | 零交叉率阈值 |

**调优建议**：
- 对噪声环境提高 `silence_rms_threshold` 到 0.02
- 对音乐降低到 0.005（音乐动态范围大）

### 陡增参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `min_history_frames` | 5 | 历史窗口大小 |
| 倍数阈值（硬编码） | 3.0 | 当前 RMS / 平均 RMS |
| `avg_rms > 0.05` | 0.05 | 最小平均值门槛 |

**调优建议**：
- 更严格检测：改为 2.5 倍
- 更宽松检测：改为 5.0 倍
- 更长历史：改为 10 帧（100ms）

---

## 与前后帧对比的区别

### 方案 A：简单前后帧对比（未采用）

```python
# 计算相邻帧的 RMS 差异
rms_change = abs(current_rms - prev_rms) / (prev_rms + 1e-6)

if rms_change > 2.0:  # 变化超过 2 倍
    报告陡变
```

**问题**：
- ❌ 对正常语调变化过于敏感
- ❌ 说话中的重音、语气词会误报
- ❌ 无法区分"正常变化"和"异常突变"

### 方案 B：历史平均对比（当前采用）

```python
# 对比最近 5 帧的平均值
avg_rms = mean([最近5帧])

if current_rms > avg_rms * 3.0:
    报告陡增
```

**优势**：
- ✅ 平滑短期波动
- ✅ 更鲁棒，不易误报
- ✅ 能捕捉真正的"突然"变化

---

## 实际检测示例

### 示例 1：网络掉线（陡降）

```
时间轴:  0.0s   0.5s   1.0s   1.5s   2.0s
RMS:     0.30 → 0.28 → 0.003 → 0.002 → 0.25
事件:                    ↑ 陡降！(RMS < 0.01)
```

### 示例 2：麦克风啸叫（陡增）

```
时间轴:  0.0s   0.5s   1.0s   1.2s   1.4s
RMS:     0.15 → 0.18 → 0.16 → 0.92 → 0.15
平均:    [5帧] = 0.164
事件:                    ↑ 陡增！(0.92 > 0.164*3)
```

### 示例 3：正常语音变化（不触发）

```
时间轴:  0.0s   0.5s   1.0s   1.5s   2.0s
RMS:     0.10 → 0.25 → 0.15 → 0.30 → 0.12
平均:    [最近5帧] ≈ 0.18
                           ↑ 0.30 < 0.18*3 (0.54)
事件:    无 - 这是正常语调变化
```

---

## 改进建议

### 如果想使用 dB 值检测

可以修改 `dropout.py`：

```python
import numpy as np

def detect(self, features, frame, prev_features=None, is_voice_active=True):
    rms = features.get("rms", 0)
    
    # 转换为 dB
    if rms > 1e-6:
        db = 20 * np.log10(rms / 1.0)  # 参考值 1.0
    else:
        db = -100  # 极小值处理
    
    # 获取历史 dB
    recent_db_list = []
    for h in self.history[-5:]:
        h_rms = h["features"]["rms"]
        if h_rms > 1e-6:
            recent_db_list.append(20 * np.log10(h_rms / 1.0))
        else:
            recent_db_list.append(-100)
    
    if recent_db_list:
        avg_db = np.mean(recent_db_list)
        
        # 检测：突然增加 > 10dB
        if db - avg_db > 10:
            return DetectionEvent(...)
```

**判断标准变化**：
- 线性：3 倍 → dB：+9.5 dB
- 线性：5 倍 → dB：+14 dB
- 线性：10 倍 → dB：+20 dB

---

## 总结

| 特性 | 陡降检测 | 陡增检测 |
|------|---------|---------|
| **方法** | 绝对值阈值 | 历史平均对比 |
| **对比对象** | 固定阈值 (0.01) | 最近5帧平均 |
| **倍数** | - | 3倍 |
| **使用 dB** | ❌ 否 | ❌ 否 |
| **历史依赖** | 无 | 需要5帧 |
| **适用场景** | 静音/掉线 | 啸叫/尖刺 |

**核心差异**：
- ✅ 使用 **RMS 线性值**，不是 dB
- ✅ 陡增对比 **历史平均**，不是单个前帧
- ✅ 陡降用 **绝对阈值**，不依赖历史
