# 语音质量检测原理详解

本文档详细说明四种质量问题的检测原理、算法实现和配置参数。

---

## 📊 核心特征提取

所有检测器基于以下5个音频特征（每帧10ms）：

### 1. RMS（Root Mean Square）- 均方根能量
```
RMS = √(Σ(采样点²) / N)
```
- **物理意义**：音频信号的能量/响度
- **范围**：0.0 ~ 1.0（归一化后）
- **用途**：检测音量变化、卡顿、静音

### 2. 零交叉率（Zero Crossing Rate, ZCR）
```
ZCR = Σ(sign(x[n]) ≠ sign(x[n-1])) / N
```
- **物理意义**：信号穿越零点的频率
- **特性**：
  - 清晰人声：ZCR ≈ 0.03 ~ 0.12（低频为主）
  - 噪声/摩擦音：ZCR > 0.15（高频成分多）
- **用途**：区分语音与噪声、检测静音真实性

### 3. 频谱质心（Spectral Centroid）
```
质心 = Σ(频率 × 幅度) / Σ幅度
```
- **物理意义**：频谱的"重心"频率，代表音色明亮度
- **范围**：80 ~ 3000 Hz（正常人声）
- **特性**：
  - 低频音（男声低音）：质心 ≈ 150 Hz
  - 高频音（女声高音）：质心 ≈ 800 Hz
  - 尖锐/金属音：质心 > 2000 Hz
- **用途**：检测音色失真、变声

### 4. 频谱带宽（Spectral Bandwidth）
```
带宽 = √(Σ((频率 - 质心)² × 幅度) / Σ幅度)
```
- **物理意义**：频谱分布的宽度/离散度
- **特性**：
  - 纯音：带宽窄
  - 噪声：带宽宽
  - 正常语音：带宽稳定
- **用途**：检测编码器崩溃、频响异常

### 5. 频谱流量（Spectral Flux）
```
流量 = Σ|当前帧频谱 - 前一帧频谱|
```
- **物理意义**：相邻帧频谱变化幅度
- **特性**：
  - 稳定语音：流量低（< 0.1）
  - 音色突变：流量高（> 0.2）
- **用途**：检测编码失真、回声消除错误

---

## 🔊 1. 噪声检测（Noise Detection）

### 检测目标
- ✅ **突发噪声**：爆音、电磁干扰、碰撞声（默认启用）
- ⚙️ **背景噪声**：电流声、环境噪声（需手动启用）

### 检测原理

#### 1.1 背景噪声检测（可选）
```python
if detect_background_noise and ZCR > 0.15:
    → 检测为背景噪声
```

**原理**：
- 噪声的零交叉率远高于清晰语音
- 人声主要是低频能量（声带振动），ZCR 较低
- 噪声包含大量高频成分，频繁穿越零点

**对比表**：
| 音频类型 | ZCR 范围 | 原因 |
|---------|---------|------|
| 清晰人声 | 0.03 ~ 0.12 | 低频基音为主 |
| 摩擦音/清音 | 0.08 ~ 0.18 | 无浊音、高频成分 |
| 电流噪声 | > 0.15 | 随机高频振动 |
| 风噪 | > 0.20 | 宽频噪声 |

#### 1.2 突发噪声检测（默认启用）
```python
if (当前RMS - 前一帧RMS) / 前一帧RMS > 0.3:
    → 检测为突发噪声
```

**原理**：
- 突发噪声在时域上表现为能量骤增
- 正常语音能量变化平滑（除爆破音）
- 30% 增幅阈值过滤正常音量变化

**典型场景**：
- 键盘敲击声
- 手机接近麦克风
- 电磁干扰脉冲
- 线材接触不良

### 配置参数
```python
"detect_background_noise": False,  # 背景噪声检测开关（默认关闭）
"noise_zcr_threshold": 0.15,      # ZCR阈值（超过则为噪声）
"burst_spike_threshold": 0.3,      # 突发噪声阈值（30%增幅）
```

### 调优建议
- **高噪声环境**：开启 `detect_background_noise`，降低 `noise_zcr_threshold` 到 0.12
- **录音室环境**：关闭背景噪声检测，提高 `burst_spike_threshold` 到 0.4

---

## 🔇 2. 卡顿检测（Dropout Detection）

### 检测目标
只检测**静音/无声卡顿**，不检测音量突变：
- ✅ 网络丢包导致的静音
- ✅ 缓冲区欠流
- ✅ 编码器停顿
- ✅ 音频流中断

### 检测原理

```python
if RMS < 0.01 and ZCR < 0.05:
    → 检测为静音卡顿
```

**双重验证机制**：
1. **RMS极低**（< 0.01）→ 能量接近零
2. **ZCR极低**（< 0.05）→ 几乎无波形振动

**为什么需要双重验证？**

| 场景 | RMS | ZCR | 结果 |
|------|-----|-----|------|
| 真正静音 | < 0.01 | < 0.05 | ✅ 检测为卡顿 |
| 低声细语 | < 0.01 | 0.08 | ❌ 不检测（有内容） |
| 静态背景噪声 | 0.02 | < 0.05 | ❌ 不检测（有能量） |
| 高频噪声 | < 0.01 | 0.15 | ❌ 不检测（有波动） |

**典型波形特征**：
```
正常语音:  ▁▃▅▇█▇▅▃▁  (RMS波动, ZCR适中)
静音卡顿:  ________  (RMS=0, ZCR=0)
低声语音:  ▁▁▂▁▁▁▂  (RMS低, 但ZCR>0.05)
```

### 配置参数
```python
"silence_rms_threshold": 0.01,     # 静音RMS阈值
"dropout_zcr_threshold": 0.05,     # 静音ZCR阈值
```

### 调优建议
- **降低误报**：提高 `silence_rms_threshold` 到 0.015
- **提高灵敏度**：降低到 0.005（可能误报低声细语）

---

## 📈 3. 音量波动检测（Volume Fluctuation Detection）

### 检测目标
检测**短时间内剧烈的音量变化**：
- AGC（自动增益控制）失效
- 设备接触不良
- 用户距离麦克风忽远忽近

### 检测原理

```python
最近3帧的音量比值 = max(RMS) / min(RMS)

if 音量比值 > 1.4:
    → 检测为音量波动
```

**时间窗口**：30ms（3帧 × 10ms）

**原理说明**：
- 正常语音音量相对平稳，3帧内变化 < 40%
- AGC 故障会导致音量来回调整（Pumping效应）
- 40% 阈值过滤正常的轻重音差异

**对比表**：
| 场景 | 3帧RMS序列 | 比值 | 结果 |
|------|-----------|------|------|
| 正常语音 | [0.3, 0.32, 0.28] | 1.14 | ❌ 正常 |
| AGC Pumping | [0.2, 0.4, 0.15] | 2.67 | ✅ 检测为波动 |
| 轻重音对比 | [0.25, 0.35, 0.30] | 1.40 | ⚠️ 边界值 |
| 用户移动 | [0.4, 0.1, 0.5] | 5.0 | ✅ 检测为波动 |

### 配置参数
```python
"rms_change_threshold": 0.4,  # 波动阈值（40%变化）
```

### 调优建议
- **降低误报**：提高到 0.5（50%变化）
- **提高灵敏度**：降低到 0.3（30%变化）

---

## 🎵 4. 失真/变声检测（Distortion Detection）

### 检测目标
检测**频谱异常导致的音色失真**：
- 编码器失效
- 回声消除错误
- 频率响应异常
- 机器人音/变声器效果

### 检测原理

失真检测有两种模式：

#### 4.1 基于标定基线对比（推荐，需先标定）

```python
# 前提：已调用 calibrate() 建立基线

# 检测1：高频谱流量
if 当前频谱流量 > 基线频谱流量 × 2:
    → 检测为频谱突变

# 检测2：质心偏移
if |当前质心 - 基线质心| > 500 Hz:
    → 检测为音色失真

# 检测3：带宽激增
if 当前带宽 > 基线带宽 × 1.5:
    → 检测为频响异常
```

**原理**：
- 标定文件建立"正常语音"的频谱基线
- 测试文件与基线对比，检测异常偏离
- 消除设备差异和个人音色差异的影响

**典型场景对比**：

| 场景 | 频谱流量 | 质心偏移 | 带宽变化 |
|------|---------|---------|---------|
| 正常语音 | 0.05 ~ 0.10 | < 200 Hz | < 20% |
| 编码器失效 | > 0.20 | 不定 | > 50% |
| 回声消除错误 | > 0.30 | 不定 | > 30% |
| 频响失真（高频） | 0.10 ~ 0.15 | +500 ~ +1000 Hz | +20% ~ +40% |
| 频响失真（低频） | 0.10 ~ 0.15 | -300 ~ -800 Hz | -10% ~ -30% |
| 机器人音 | > 0.25 | 剧烈波动 | > 40% |

#### 4.2 相邻帧对比模式（兼容模式，未标定时使用）

```python
# 检测1：高频谱流量
if 当前频谱流量 > 0.2:
    → 检测为频谱突变

# 检测2：质心偏移
if |当前质心 - 前一帧质心| > 500 Hz:
    → 检测为音色失真

# 检测3：带宽激增
if 当前带宽 > 前一帧带宽 × 1.5:
    → 检测为频响异常
```

**局限性**：
- 无法检测持续性的失真（如整段机器人音）
- 只能检测瞬时突变
- 易受正常音素切换影响（如元音→辅音）

### 使用建议

**标准流程（推荐）**：
```python
# 1. 标定阶段
analyzer.calibrate(标定音频帧)  # 建立baseline

# 2. 检测阶段
analyzer.analyze(测试音频帧)  # 自动使用baseline对比
```

**快速检测（无标定）**：
```python
# 直接分析
analyzer.analyze(音频帧)  # 使用相邻帧对比模式
```

### 配置参数
```python
"spectral_flux_threshold": 0.2,        # 频谱流量阈值
"centroid_shift_threshold": 500.0,     # 质心偏移阈值(Hz)
"bandwidth_spike_threshold": 1.5,      # 带宽激增阈值(倍数)
```

### 调优建议

**降低误报（严格模式）**：
```python
"spectral_flux_threshold": 0.25,
"centroid_shift_threshold": 700.0,
"bandwidth_spike_threshold": 1.8,
```

**提高灵敏度（敏感模式）**：
```python
"spectral_flux_threshold": 0.15,
"centroid_shift_threshold": 400.0,
"bandwidth_spike_threshold": 1.3,
```

---

## ⚙️ 配置预设

### DEFAULT_CONFIG（默认配置，适用于VoIP/电话质量检测）
```python
DEFAULT_CONFIG = {
    # 噪声检测
    "detect_background_noise": False,
    "noise_zcr_threshold": 0.15,
    "burst_spike_threshold": 0.3,
    
    # 卡顿检测
    "silence_rms_threshold": 0.01,
    "dropout_zcr_threshold": 0.05,
    
    # 音量波动检测
    "rms_change_threshold": 0.4,
    
    # 失真检测
    "spectral_flux_threshold": 0.2,
    "centroid_shift_threshold": 500.0,
    "bandwidth_spike_threshold": 1.5,
    
    # 最小事件持续时间
    "min_event_duration": {
        "noise": 0.15,              # 150ms
        "dropout": 0.05,            # 50ms（最敏感）
        "volume_fluctuation": 0.25, # 250ms
        "voice_distortion": 0.12,   # 120ms
    }
}
```

### CLEAN_SPEECH_CONFIG（干净语音配置，适用于录音室/播客）
```python
CLEAN_SPEECH_CONFIG = {
    **DEFAULT_CONFIG,
    # 放宽4倍，减少误报
    "min_event_duration": {
        "noise": 0.60,              # 600ms
        "dropout": 0.20,            # 200ms
        "volume_fluctuation": 1.00, # 1000ms
        "voice_distortion": 0.50,   # 500ms
    }
}
```

---

## 🔬 检测流程

```
音频输入
   ↓
分帧（10ms/帧，50%重叠）
   ↓
特征提取（5项特征）
   ↓
┌─────────────────────────────────┐
│   四个检测器并行工作            │
│  ┌────────┐  ┌────────┐         │
│  │噪声检测│  │卡顿检测│         │
│  └────────┘  └────────┘         │
│  ┌────────┐  ┌────────┐         │
│  │音量波动│  │失真检测│         │
│  └────────┘  └────────┘         │
└─────────────────────────────────┘
   ↓
事件收集
   ↓
后处理（finalize）
   ├─ 合并相邻事件（gap < 150ms）
   └─ 过滤短事件（按类型）
   ↓
输出结果
```

---

## 📏 人耳感知阈值设计

根据声学研究和 ITU-T 标准，不同问题的最小持续时间阈值：

| 问题类型 | 最小持续时间 | 人耳感知特性 |
|---------|-------------|-------------|
| **卡顿** | 50ms | 最敏感！>20ms 就能察觉间隙 |
| **变声/失真** | 120ms | 对音色变化敏感，但瞬时变化不明显 |
| **噪声** | 150ms | 短暂噪音爆发通常被忽略 |
| **音量波动** | 250ms | 人耳对音量变化相对迟钝 |

**过滤策略**：
- 事件持续时间 < 阈值 → 忽略（环境干扰）
- 事件持续时间 ≥ 阈值 → 上报（真实问题）

---

## 🎯 典型应用场景

### 场景1：VoIP 通话质量监测
```python
config = DEFAULT_CONFIG
config["detect_background_noise"] = True  # 启用背景噪声检测
analyzer = Analyzer(config=config)
```

### 场景2：播客后期质量检查
```python
config = CLEAN_SPEECH_CONFIG
analyzer = Analyzer(config=config)
```

### 场景3：设备标定与测试
```python
# 步骤1：标定
analyzer.calibrate(clean_audio_frames)

# 步骤2：测试
result = analyzer.analyze(test_audio_frames)

# 失真检测将基于标定基线
```

---

## 📚 参考文献

1. **ITU-T P.800** - Methods for subjective determination of transmission quality
2. **ITU-T P.862** - Perceptual evaluation of speech quality (PESQ)
3. **Spectral Flux** - Masri, P. (1996). "Computer modeling of sound for transformation and synthesis of musical signals"
4. **Voice Activity Detection** - Sohn, J. et al. (1999). "A statistical model-based voice activity detection"

---

## 🔧 故障排查

### 问题1：误报过多
**原因**：阈值过于敏感
**解决**：
- 使用 `CLEAN_SPEECH_CONFIG`
- 提高 `min_event_duration`
- 提高各检测器阈值

### 问题2：漏报严重
**原因**：阈值过于宽松
**解决**：
- 使用 `DEFAULT_CONFIG`
- 降低 `min_event_duration`
- 降低各检测器阈值

### 问题3：失真检测不准确
**原因**：未建立 baseline
**解决**：
- 使用 `calibrate()` 建立基线
- 确保标定音频质量高且代表性强

### 问题4：背景噪声误报为语音问题
**原因**：背景噪声检测未启用
**解决**：
- 设置 `detect_background_noise: True`
- 调整 `noise_zcr_threshold`

---

**文档版本**：1.0  
**最后更新**：2025年12月18日
