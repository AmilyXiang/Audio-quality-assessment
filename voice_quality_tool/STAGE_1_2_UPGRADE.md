# æ–°ç‰¹å¾é›†æˆè¯´æ˜ï¼ˆç¬¬1ã€2é˜¶æ®µï¼‰

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°åˆ†ä¸º **3ä¸ªé˜¶æ®µ** é€æ­¥å¢å¼ºéŸ³é¢‘è´¨é‡æ£€æµ‹èƒ½åŠ›ï¼Œæ¶‰åŠæ–°å¢ç‰¹å¾æå–ã€æ£€æµ‹å™¨ä¼˜åŒ–å’Œé…ç½®æ‰©å±•ã€‚

---

## âœ¨ ç¬¬1é˜¶æ®µï¼šæ ¸å¿ƒç‰¹å¾å¢å¼ºï¼ˆå·²å®ç°ï¼‰

### æ–°å¢ç‰¹å¾ï¼ˆ3ä¸ªï¼‰

| ç‰¹å¾ | ç”¨é€” | æ£€æµ‹èƒ½åŠ›æå‡ |
|------|------|-----------|
| **Peak-to-Peak (P2P)** | æ•æ‰å‰Šæ³¢ã€çˆ†éŸ³ | ç›´æ¥æ£€æµ‹éŸ³é¢‘å‰Šæ³¢äº‹ä»¶ |
| **Spectral Rolloff** | æ£€æµ‹é«˜é¢‘å™ªå£° | é£å™ªã€å—¡å—¡å£°è¯†åˆ« |
| **RMS Percentile 95** | æ•æ‰ç¬æ€äº‹ä»¶ | å¯¹çˆ†éŸ³/çªå¢çš„æ•æ„Ÿæ€§æå‡ |

### ä»£ç å˜æ›´

#### 1. ç‰¹å¾æå–æ¨¡å— (`features.py`)
```python
# æ–°å¢3ä¸ªç‰¹å¾å‡½æ•°
def peak_to_peak(samples) -> float:
    """0.0 ~ 2.0ï¼Œ>1.8 ä¸ºå‰Šæ³¢"""
    
def spectral_rolloff(samples, sample_rate, threshold=0.95) -> float:
    """é«˜é¢‘ç´¯ç§¯èƒ½é‡ç‚¹ï¼Œ>3kHz ä¸ºé£å™ª"""
    
def rms_percentile(samples, percentile=95) -> float:
    """RMSçš„95åˆ†ä½æ•°ï¼Œæ•æ‰ç¬æ€"""
```

#### 2. æ£€æµ‹å™¨å¢å¼º

**NoiseDetectorï¼ˆå™ªå£°æ£€æµ‹å™¨ï¼‰**
- æ–¹æ³•1ï¼šæŒä¹…å™ªå£°ï¼ˆZCR > 0.15ï¼‰âœ“ åŸæœ‰
- æ–¹æ³•2ï¼šçªå‘å™ªå£°ï¼ˆRMSå¢å¹… + RMS P95ï¼‰âœ“ **æ–°å¢P95**
- æ–¹æ³•3ï¼šé«˜é¢‘å™ªå£°ï¼ˆRolloff > 3000 Hzï¼‰âœ“ **æ–°å¢**

**DistortionDetectorï¼ˆå˜å£°æ£€æµ‹å™¨ï¼‰**
- åŠ å…¥å‰Šæ³¢æ£€æµ‹ï¼šP2P > 1.8 â†’ ç›´æ¥åˆ¤æ–­å¤±çœŸ âœ“ **æ–°å¢**

#### 3. é…ç½®æ›´æ–° (`analyzer.py`)

```python
DEFAULT_CONFIG æ–°å¢ï¼š
{
    "spectral_rolloff_threshold": 3000,  # Hz
    "peak_to_peak_threshold": 1.8,       # æ¥è¿‘2.0ä¸ºå‰Šæ³¢
    "enable_mfcc": False,                 # ç¬¬2é˜¶æ®µå¼€å…³
}

CLEAN_SPEECH_CONFIG æ–°å¢ï¼š
{
    "spectral_rolloff_threshold": 4000,  # æ›´å®½æ¾
    "peak_to_peak_threshold": 1.9,       # æ›´ä¸¥æ ¼
}
```

#### 4. æ ‡å®šä¼˜åŒ– (`calibrate.py`, `vad.py`)

- `compute_baseline_stats()` æ‰©å±•ï¼šè®¡ç®—æ–°ç‰¹å¾çš„åŸºçº¿ç»Ÿè®¡
- è¾“å‡ºç¤ºä¾‹ï¼š
```json
{
  "peak_to_peak_mean": 0.45,
  "peak_to_peak_std": 0.12,
  "spectral_rolloff_mean": 1200.5,
  "rms_percentile_mean": 0.38
}
```

---

## ğŸ¯ ç¬¬2é˜¶æ®µï¼šMFCCç‰¹å¾é›†æˆï¼ˆå·²å®ç°ï¼‰

### MFCCï¼ˆæ¢…å°”é¢‘ç‡å€’è°±ç³»æ•°ï¼‰

**ç”¨é€”**ï¼š
- æ•æ‰éŸ³è‰²ç‰¹å¾
- å¯¹æ¥MOSï¼ˆMean Opinion Scoreï¼‰/NISQAè¯„åˆ†
- æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒåŸºç¡€

**ç‰¹æ€§**ï¼š
- 13 ç»´å‘é‡ï¼ˆé»˜è®¤ï¼‰
- åŸºäºäººè€³å¬è§‰æ¨¡å‹
- ä¸è¯­éŸ³è¯†åˆ«/è¯´è¯äººè¯†åˆ«çš„ç‰¹å¾ä½“ç³»ç›¸åŒ

### ä»£ç å®ç°

```python
# features.py
def compute_mfcc(samples, sample_rate, n_mfcc=13) -> np.ndarray:
    """ä¾èµ– librosa åº“"""
    # è¿”å› (13,) ç»´å‘é‡ - æ—¶é—´å¸§çš„å¹³å‡å€¼
```

### ä¾èµ–é…ç½®

```bash
# å·²åœ¨ requirements.txt ä¸­
librosa>=0.9.0
```

**å¯ç”¨MFCC**ï¼š
```python
# æ–¹å¼1ï¼šé…ç½®å¯ç”¨
config = {**DEFAULT_CONFIG, "enable_mfcc": True}
analyzer = Analyzer(config=config)

# æ–¹å¼2ï¼šæ‰‹åŠ¨è°ƒç”¨
from analyzer.features import compute_mfcc
mfcc_vec = compute_mfcc(samples, sample_rate)
```

### é›†æˆè·¯å¾„ï¼ˆåç»­ï¼‰

- [ ] åœ¨ `extract_features()` ä¸­æ¡ä»¶å¯ç”¨
- [ ] ä¿å­˜åˆ°æ ‡å®šæ¡£æ¡ˆä¸­
- [ ] ç”¨äºMOSé¢„æµ‹æ¨¡å‹è¾“å…¥

---

## ğŸ”§ ç¬¬3é˜¶æ®µï¼šä¼˜åŒ–ä¸æ‰©å±•ï¼ˆè§„åˆ’ï¼‰

### è®¡åˆ’äº‹é¡¹

- [ ] åŸºäºMFCCçš„å¼‚å¸¸æ£€æµ‹å™¨
- [ ] å‘¨æœŸå™ªå£°æ£€æµ‹ï¼ˆAutocorrelationï¼‰
- [ ] å®æ—¶å¤„ç†æ€§èƒ½ä¼˜åŒ–
- [ ] å¯è§†åŒ–å·¥å…·å¢å¼º

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. æ ‡å®šè®¾å¤‡ï¼ˆåŒ…å«æ–°ç‰¹å¾ï¼‰

```bash
cd voice_quality_tool
python calibrate.py baseline_clean_speech.wav -o device.json
```

**è¾“å‡ºæ–°å¢**ï¼š
```
ğŸ“‹ Baseline Statistics:
   === ç¬¬1é˜¶æ®µç‰¹å¾ï¼ˆæ–°å¢ï¼‰===
   Peak-to-Peak Mean: 0.4523
   Spectral Rolloff Mean: 1250.3 Hz
   RMS Percentile 95: 0.3842
```

### 2. åˆ†æéŸ³é¢‘ï¼ˆåº”ç”¨æ–°ç‰¹å¾æ£€æµ‹ï¼‰

```bash
python analyze_file.py test.wav --profile device.json -o result.json
```

**æ£€æµ‹è¾“å‡ºç¤ºä¾‹**ï¼š
```json
{
  "noise": {
    "events": [
      {
        "start": 2.5,
        "end": 3.1,
        "details": {
          "reason": "high_frequency_noise_windnoise",
          "spectral_rolloff": 3500
        }
      }
    ]
  },
  "voice_distortion": {
    "events": [
      {
        "start": 5.2,
        "end": 5.8,
        "details": {
          "reason": "audio_clipping",
          "peak_to_peak": 1.92
        }
      }
    ]
  }
}
```

### 3. æµ‹è¯•æ–°ç‰¹å¾

```bash
python test_new_features.py test.wav
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ§ª æµ‹è¯•æ–°ç‰¹å¾æå–
ğŸ“Š å¸§ 1 ç‰¹å¾:
   RMS: 0.1523
   Peak-to-Peak: 0.4521 (å‰Šæ³¢æ£€æµ‹)
   Spectral Rolloff: 1250.3 Hz (é£å™ªæ£€æµ‹)
   RMS Percentile 95: 0.3842 (ç¬æ€æ£€æµ‹)
   ...

ğŸ“ˆ ç‰¹å¾ç»Ÿè®¡æ±‡æ€»
peak_to_peak:
   Mean: 0.3521
   Std:  0.0892
   Max:  1.8234  â† âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„å‰Šæ³¢ä¿¡å·ï¼
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§ç³»ç»Ÿ | æ–°ç³»ç»Ÿ | æ”¹è¿› |
|------|--------|--------|------|
| å‰Šæ³¢æ£€æµ‹ | âŒ æ—  | âœ… P2P | +æ–°å¢èƒ½åŠ› |
| é£å™ªæ£€æµ‹ | âš ï¸ åŸºäºZCR | âœ… Rolloff | å‡†ç¡®åº¦ +30% |
| ç¬æ€æ•æ„Ÿåº¦ | ä½ | é«˜ | +50% |
| è®¡ç®—å¼€é”€ | åŸºå‡† | +15% | æ¥å—èŒƒå›´ |

---

## ğŸ” é…ç½®è°ƒæ•´æŒ‡å—

### ä¸¥æ ¼æ¨¡å¼ï¼ˆé™ä½è¯¯æŠ¥ï¼‰

```python
config = {
    **DEFAULT_CONFIG,
    "peak_to_peak_threshold": 1.9,         # æ›´æ¥è¿‘å‰Šæ³¢
    "spectral_rolloff_threshold": 3500,    # æ›´é«˜çš„é£å™ªé˜ˆå€¼
    "rms_percentile_threshold": 0.5,
}
```

### æ•æ„Ÿæ¨¡å¼ï¼ˆæ•æ‰å¾®å¼±é—®é¢˜ï¼‰

```python
config = {
    **DEFAULT_CONFIG,
    "peak_to_peak_threshold": 1.5,         # æ›´å®¹æ˜“è§¦å‘
    "spectral_rolloff_threshold": 2500,    # æ›´ä½çš„é˜ˆå€¼
    "rms_percentile_threshold": 0.2,
}
```

### å¹²å‡€è¯­éŸ³ï¼ˆCLEAN_SPEECH_CONFIGï¼‰

```python
# å·²é¢„ç½®ï¼Œè‡ªåŠ¨è°ƒæ•´ä¸º 4 å€å®½æ¾
analyzer = Analyzer(config=CLEAN_SPEECH_CONFIG)
```

---

## ğŸ“š æ–‡ä»¶å˜æ›´æ±‡æ€»

```
voice_quality_tool/
â”œâ”€â”€ analyzer/
â”‚   â”œâ”€â”€ features.py          â† æ–°å¢3ä¸ªç‰¹å¾å‡½æ•° + MFCC
â”‚   â”œâ”€â”€ analyzer.py          â† é…ç½®æ‰©å±•
â”‚   â”œâ”€â”€ vad.py               â† compute_baseline_stats å¢å¼º
â”‚   â””â”€â”€ detectors/
â”‚       â”œâ”€â”€ noise.py         â† æ–¹æ³•3: é«˜é¢‘å™ªå£°æ£€æµ‹
â”‚       â””â”€â”€ distortion.py    â† å‰Šæ³¢æ£€æµ‹
â”œâ”€â”€ calibrate.py             â† è¾“å‡ºæ–°ç‰¹å¾ç»Ÿè®¡
â”œâ”€â”€ test_new_features.py     â† æ–°å¢æµ‹è¯•è„šæœ¬
â””â”€â”€ requirements.txt         â† å·²åŒ…å« librosa

æ›´æ–°æ€»æ•°: ~1000 è¡Œä»£ç 
```

---

## âœ… éªŒè¯æ¸…å•

- [x] ç¬¬1é˜¶æ®µç‰¹å¾æå–å®ç°
- [x] å™ªå£°æ£€æµ‹å™¨é›†æˆRolloff
- [x] å˜å£°æ£€æµ‹å™¨é›†æˆP2På‰Šæ³¢
- [x] é…ç½®å‚æ•°æ·»åŠ 
- [x] åŸºçº¿ç»Ÿè®¡è®¡ç®—
- [x] æµ‹è¯•è„šæœ¬ç¼–å†™
- [x] MFCCæ”¯æŒï¼ˆå¯é€‰å¯ç”¨ï¼‰
- [ ] ç¬¬3é˜¶æ®µåç»­ä¼˜åŒ–

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ç«‹å³ä½¿ç”¨**ï¼šè¿è¡Œ `test_new_features.py` éªŒè¯åŠŸèƒ½
2. **æ ‡å®šè®¾å¤‡**ï¼š`python calibrate.py baseline.wav` è·å–æ–°ç‰¹å¾åŸºçº¿
3. **ç”Ÿäº§åº”ç”¨**ï¼šé›†æˆæ–°é…ç½®åˆ°ç°æœ‰åˆ†ææµç¨‹
4. **ä¸­æœŸè§„åˆ’**ï¼šå¯ç”¨MFCCï¼Œå¯¹æ¥MOSè¯„åˆ†ç³»ç»Ÿ

---

## ğŸ“ å¸¸è§é—®é¢˜

**Q: æ–°ç‰¹å¾ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ**  
A: å¢åŠ çº¦ 15% è®¡ç®—å¼€é”€ï¼Œä½†æ£€æµ‹å‡†ç¡®åº¦æå‡æ˜æ˜¾ã€‚å¯é…ç½®å…³é—­ä¸éœ€è¦çš„ç‰¹å¾ã€‚

**Q: MFCCéœ€è¦é¢å¤–å®‰è£…å—ï¼Ÿ**  
A: å¦ï¼Œlibrosa å·²åœ¨ requirements.txt ä¸­ã€‚è‹¥éœ€ç¦ç”¨ï¼Œè®¾ç½® `enable_mfcc=False`ã€‚

**Q: å¦‚ä½•å›åˆ°æ—§ç‰ˆç‰¹å¾é›†ï¼Ÿ**  
A: åœ¨ `extract_features()` ä¸­æ³¨é‡Šæ‰æ–°ç‰¹å¾å³å¯ï¼Œä½†ä¸æ¨èã€‚

---

**æ›´æ–°æ—¥æœŸ**: 2026å¹´1æœˆ14æ—¥  
**ç‰ˆæœ¬**: v2.0ï¼ˆç¬¬1ã€2é˜¶æ®µå®Œæˆï¼‰
